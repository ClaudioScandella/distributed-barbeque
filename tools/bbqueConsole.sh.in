#!/bin/bash

# Source the BOSP Shell configuration
source @CMAKE_INSTALL_PREFIX@/etc/bbque/bosp_init.env

# CONSOLE CONFIGURATION
BBQUE_SYSROOT="${BBQUE_SYSROOT:-$SYSROOT}"
BBQUE_CONF="${BBQUE_CONF:-$CONF}"
BBQUE_PILLAYOUT="${BBQUE_PILLAYOUT:-$PILLAYOUT}"
BBQUE_SUPDATE="${BBQUE_SUPDATE:-1}"
BBQUE_LOGFILE="${BBQUE_LOGFILE:-$BBQUE_SYSROOT/var/bbque/bbque.log}"

# - XWindows geometries recoveder using "xwininfo" utility
# - Font is configured by "-fn" option, to see a list of fonts run:
#     "xlsfonts | less"
FONT=-misc-fixed-medium-r-normal--10-100-75-75-c-60-iso10646-1


mkdir -p $BBQUE_SYSROOT/var/bbque 2>/dev/null
cat > $BBQUE_SYSROOT/var/bbque/BbqConsole_Resources.sh <<EOF
#!/bin/bash

function bosp_dump_tasks {

echo -ne "\E[30;42m"
echo "                                                                          "
echo "                    Managed Applications: EXCs                            "
echo "                                                                          "
echo -ne "$BOSPSH_RESET$BOSPSH_DEFAULT"
for APP in \`find $BBQUE_SYSROOT/mnt/cgroup/bbque/ -maxdepth 1 -type d\`; do
	NAME=\`basename \$APP\`
	if [ \$NAME == "bbque" -o \$NAME == "silos" -o \$NAME == "res" -o \$NAME == "host" ]; then
		continue
	fi

	CPUS=\`cat \$APP/cpuset.cpus\`
	CPUQ=\`cat \$APP/cpu.cfs_quota_us\`
	CPUP=\`cat \$APP/cpu.cfs_period_us\`
	MEMN=\`cat \$APP/cpuset.mems\`
	MEMB=\`cat \$APP/memory.limit_in_bytes\`
	MEMU=\`cat \$APP/memory.max_usage_in_bytes\`
	MEMC=\`cat \$APP/memory.stat | grep rss | head -n1 | cut -d" " -f2\`

	let CPUU=(CPUQ * 100)/CPUP

	echo ".:: \$NAME"
	echo "    CPUs: \$CPUS - \${CPUU}% {P: \$CPUP, Q: \$CPUQ}"
	echo "    MEMs: \$MEMB - \${MEMN}[nodes] {C: \$MEMC, M: \$MEMU}"
done
}

while [ 1 ]; do
	clear
	printf "BOSP Console :: Tasks Monitor %40s\n\n" "\`date +%c\`"
	if [ -d $BBQUE_SYSROOT/mnt/cgroup/bbque ]; then
		bosp_dump_tasks
	else
		echo -ne "\nBbqued NOT running\n\n"
	fi
	sleep $BBQUE_SUPDATE
done


EOF
chmod a+x $BBQUE_SYSROOT/var/bbque/BbqConsole_Resources.sh

cat > $BBQUE_SYSROOT/var/bbque/BbqConsole_CGroups.sh <<EOF
#!/bin/bash

function bosp_dump_resources {

echo -ne "\E[30;42m"
echo "                                                                          "
echo "                    System Resources: Main TARGET                         "
echo "                                                                          "
echo -ne "$BOSPSH_RESET$BOSPSH_DEFAULT"
for TRG in \`find $BBQUE_SYSROOT/mnt/cgroup/bbque/ -maxdepth 1 -type d\`; do
	NAME=\`basename \$TRG\`
	if [ \$NAME != "bbque" -a \$NAME != "silos" -a \$NAME != "host" -o \$NAME == "res" ]; then
		continue
	fi

	CPUS=\`cat \$TRG/cpuset.cpus\`
	CPUQ=\`cat \$TRG/cpu.cfs_quota_us\`
	CPUP=\`cat \$TRG/cpu.cfs_period_us\`
	MEMN=\`cat \$TRG/cpuset.mems\`
	MEMB=\`cat \$TRG/memory.limit_in_bytes\`
	MEMU=\`cat \$TRG/memory.max_usage_in_bytes\`

	let CPUU=(CPUQ * 100)/CPUP

	echo ".:: \$NAME"
	echo "    CPUs: \$CPUS - \${CPUU}% {P: \$CPUP, Q: \$CPUQ}"
	echo "    MEMs: \$MEMB - \${MEMN}[nodes] {Max used: \$MEMU}"

done

echo -ne "\n\n\E[30;42m"
echo "                                                                          "
echo "                     Managed Resources: NODES                             "
echo "                                                                          "
echo -ne "$BOSPSH_RESET$BOSPSH_DEFAULT"
for TRG in \`find $BBQUE_SYSROOT/mnt/cgroup/bbque/res -maxdepth 1 -type d\`; do
	NAME=\`basename \$TRG\`
	if [ \$NAME == "res" ]; then
		continue
	fi

	CPUS=\`cat \$TRG/cpuset.cpus\`
	CPUQ=\`cat \$TRG/cpu.cfs_quota_us\`
	CPUP=\`cat \$TRG/cpu.cfs_period_us\`
	MEMN=\`cat \$TRG/cpuset.mems\`
	MEMB=\`cat \$TRG/memory.limit_in_bytes\`
	MEMU=\`cat \$TRG/memory.max_usage_in_bytes\`

	let CPUU=(CPUQ * 100)/CPUP

	echo ".:: \$NAME"
	echo "    CPUs: \$CPUS - \${CPUU}[%] {P: \$CPUP, Q: \$CPUQ}"
	echo "    MEMs: \$MEMB - \${MEMN}[nodes] {Max used: \$MEMU}"

done

}

while [ 1 ]; do
	clear
	printf "BOSP Console :: Resources Monitor %40s\n\n" "\`date +%c\`"
	if [ -d $BBQUE_SYSROOT/mnt/cgroup/bbque ]; then
		bosp_dump_resources
	else
		echo -ne "\nBbqued NOT running\n\n"
	fi
	sleep $BBQUE_SUPDATE
done

EOF
chmod a+x $BBQUE_SYSROOT/var/bbque/BbqConsole_CGroups.sh

aterm +sb -fn $FONT -geometry 136x18+-9+18 -title "Syslog" \
	-e tail -f /var/log/syslog &
aterm +sb -cr black -fn $FONT -geometry 74x55--9-17 \
	-title "BOSP Shell :: Resources Monitor" \
	-e $BBQUE_SYSROOT/var/bbque/BbqConsole_Resources.sh &
aterm +sb -cr black -fn $FONT -geometry 74x40--9+18 \
	-title "BOSP Shell :: Task Monitor" \
	-e $BBQUE_SYSROOT/var/bbque/BbqConsole_CGroups.sh &
aterm +sb -fn $FONT -geometry 136x77+-9-18 -title "BBQUE Log" \
	-e tail -f $BBQUE_LOGFILE &

